<!DOCTYPE HTML>
{% load static %}
{% load leaflet_tags %}

<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>

    {% leaflet_js %}
    {% leaflet_css %}

    <style>
        .leaflet-container {
            height: 540px;
            width: 100%;
        }
    </style>

    <link rel="stylesheet" href="{% static 'leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.min.css' %}">
    <script type="text/javascript" src="{% static 'leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.min.js' %}">
    </script>
    <script type="text/javascript" src="{% static 'leaflet-ajax/leaflet.ajax.min.js' %}"></script>

    <script type='text/javascript'>
        var Lgrp = new L.LayerGroup();
        var flayer = L.geoJSON();
        
        
        var imagery = L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                id: 'MapID',
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }),
        streets = L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                id: 'MapID',
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
            });

        
        var osmLayer;

        function buildPopup(properties){
            var text = "<strong>Building: </strong><span>"+ properties.building_name.toString() + "</span><br><strong>Floor: </strong>" + "<span>"+ properties.level.toString() + "</span>"
            
            return text;
        }
        window.addEventListener("map:init", function (event) {
            
            map = event.detail.map;

            map.eachLayer(function (layer) {
                osmLayer = layer;
            });

            map.on('contextmenu', mapclick);

            var tik_1 = new L.GeoJSON.AJAX("{% url 'TIK' 1 %}", {
                onEachFeature: function(feature, layer){
                    var text = buildPopup({building_name: feature.properties.building_name, level:feature.properties.level})
                    layer.bindPopup(text);
                }
            });
            var tik_2 = new L.GeoJSON.AJAX();//"{% url 'TIK' 2 %}", {
            //     onEachFeature: function(feature, layer){
            //         var text = buildPopup({building_name: feature.properties.building_name, level:feature.properties.level})
            //         layer.bindPopup(text);
            //     }
            // });
            var tik_3 = new L.GeoJSON.AJAX();//"{% url 'TIK' 3 %}", {
            //     onEachFeature: function(feature, layer){
            //         var text = buildPopup({building_name: feature.properties.building_name, level:feature.properties.level})
            //         layer.bindPopup(text);
            //     }
            // });

            var tuas_1 = new L.GeoJSON.AJAX("{% url 'TUAS' 1 %}", {
                onEachFeature: function(feature, layer){
                    var text = buildPopup({building_name: feature.properties.building_name, level:feature.properties.level})
                    layer.bindPopup(text);
                }
            });
            var tuas_2 = new L.GeoJSON.AJAX();//"{% url 'TUAS' 2 %}", {
            //     onEachFeature: function(feature, layer){
            //         var text = buildPopup({building_name: feature.properties.building_name, level:feature.properties.level})
            //         layer.bindPopup(text);
            //     }
            // });
            var tuas_3 = new L.GeoJSON.AJAX();//"{% url 'TUAS' 3 %}", {
            //     onEachFeature: function(feature, layer){
            //         var text = buildPopup({building_name: feature.properties.building_name, level:feature.properties.level})
            //         layer.bindPopup(text);
            //     }
            // });
            var tuas_4 = new L.GeoJSON.AJAX();//"{% url 'TUAS' 4 %}", {
            //     onEachFeature: function(feature, layer){
            //         var text = buildPopup({building_name: feature.properties.building_name, level:feature.properties.level})
            //         layer.bindPopup(text);
            //     }
            // });

            tik_1.addTo(map);
            tuas_1.addTo(map);
            
            var baseMaps = {
                "Imagery": imagery,
                "Streets": osmLayer,
            };
            var groupedOverlays = {
                "TIK": {
                    "First Floor": tik_1,
                    "Second Floor": tik_2,
                    "Third Floor": tik_3,
                },
                "TUAS": {
                    "First Floor": tuas_1,
                    "Second Floor": tuas_2,
                    "Third Floor": tuas_3,
                    "Fourth Floor": tuas_4,
                }
            };

            var options = {
                // Make the "Landmarks" group exclusive (use radio inputs)
                exclusiveGroups: ["TUAS", "TIK"],
                // Show a checkbox next to non-exclusive group labels for toggling all
                groupCheckboxes: true
            };

            var layerControl = L.control.groupedLayers(baseMaps, groupedOverlays, options);
            var baseLayerControl = L.control.groupedLayers(baseMaps); 
            map.addControl(layerControl);
            var flag = -1;
            map.on('overlayadd', onOverlayAdd);

            function onOverlayAdd(layer, name){
                console.log(layer)
                
                var buildingName = layer.group.name;
                
                // var buildingName = $(this).attr("TUAS");
                var id = $(this).attr(1);
                var url = new String();
                console.log(layer.layer.urls);
                console.log(layer.layer.urls.length)
                switch(layer.name){
                    case "First Floor":
                    if(layer.layer.urls === undefined || layer.layer.urls.length  == 0){ 
                        console.log("mierdaaa")  
                        if (layer.group.name == "TUAS"){
                            layer.layer.addUrl("{% url 'TUAS' 1 %}");
                        }
                        else{
                            layer.layer.addUrl("{% url 'TIK' 1 %}");
                        }
                    }
                        break;
                    case "Second Floor":
                        if(layer.layer.urls === undefined || layer.layer.urls.length  == 0){                       
                            if (layer.group.name == "TUAS"){
                                layer.layer.refresh("{% url 'TUAS' 2 %}");
                            }
                            else{
                                layer.layer.refresh("{% url 'TIK' 2 %}");
                            }
                        }
                        break;
                    case "Third Floor":
                        if(layer.layer.urls === undefined || layer.layer.urls.length  == 0){                       
                            if (layer.group.name == "TUAS"){
                                layer.layer.refresh("{% url 'TUAS' 3 %}");
                            }
                            else{
                                layer.layer.refresh("{% url 'TIK' 3 %}");
                            }
                        }
                        break;
                    case "Fourth Floor":
                        if(layer.layer.urls === undefined || layer.layer.urls.length  == 0){                       
                            if (layer.group.name == "TUAS"){
                                layer.layer.refresh("{% url 'TUAS' 4 %}");
                            }
                            else{
                                layer.layer.refresh("{% url 'TIK' 4 %}");
                            }
                        }
                        break;
                    default:
                    console.log("fff");
                }
                    
                layer.layer.addUrl(url);
            }
            map.on('zoomend', function() {
                
            if (map.getZoom() < 16){
                if (map.hasLayer(tik_1) ) {  
                    tik_1.remove();
                    layerControl.remove(); 
                    map.addControl(baseLayerControl); 
                    flag = 1;
                } 
                else if (map.hasLayer(tik_2)) {
                    tik_2.remove();
                    layerControl.remove(); 
                    map.addControl(baseLayerControl); 
                    flag = 2;
                }
                else if (map.hasLayer(tik_3)) {
                    tik_3.remove();
                    layerControl.remove();
                    map.addControl(baseLayerControl); 
                    flag = 3;
                }                                
                else{
                    
                }
                         
            }
            if (map.getZoom() >= 16){                
                if (flag == 1){
                    tik_1.addTo(map);
                    baseLayerControl.remove();
                    map.addControl(layerControl);
                    flag = 0
                }
                else if (flag == 2){
                    tik_2.addTo(map);
                    baseLayerControl.remove();
                    map.addControl(layerControl);
                    flag = 0
                } 
                else if (flag == 3){
                    tik_3.addTo(map);
                    baseLayerControl.remove();
                    map.addControl(layerControl);
                    flag = 0
                }
                else{
                    
                }
                
            }
        });

        }, );

        


        function mapclick(loc) {
            if (!loc.originalEvent.shiftKey) {

                if (!window.startm) {
                    window.startm = L.marker(loc.latlng);
                    window.startm.addTo(window.map);
                } else if (!window.endm) {
                    window.endm = L.marker(loc.latlng);
                    window.endm.addTo(window.map);
                    linedistance();

                } else {
                    window.endm.remove();
                    window.endm = window.startm;
                    window.startm = L.marker(loc.latlng);
                    window.startm.addTo(window.map);
                    linedistance();

                }
            }
        }

        function linedistance() {
            {
                // #a very basic dummy solution set to work at latitude of 60.187#
            }
            if (window.pline) {
                window.pline.remove();
            }
            var diff_lat = (window.endm._latlng.lat - window.startm._latlng.lat) * 111415.41;
            var diff_lng = (window.endm._latlng.lng - window.startm._latlng.lng) * 55484.77;
            var dist = Math.sqrt((Math.pow(diff_lat, 2)) + Math.pow(diff_lng, 2));

            var coords = [
                [window.startm._latlng.lat, window.startm._latlng.lng],
                [window.endm._latlng.lat, window.endm._latlng.lng]
            ];
            window.pline = L.polyline(coords, {
                color: 'red'
            });
            window.pline.bindPopup("<h5>Distance between points: " + dist + " meters!</h5>");
            window.pline.addTo(map);
            window.pline.openPopup();
            console.log(dist + " meters");
        }
    </script>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark shadow-sm">
        <a class="navbar-brand" href="#">
            <img src="{% static 'icons/Aalto.png' %}" width="65" height="60" alt=""><strong> The GISApp Project</strong>
        </a>

    </nav>
    {% leaflet_map "mappu" callback="window.tik_layers" %}
    <footer class="page-footer text-muted font-small bg-light teal pt-4">
        <div class="container-fluid text-center text-md-left">      
          <div class="row">
            <div class="col-md-6 mt-md-0 mt-3  text-center">
              <h6 class="text-uppercase font-weight-bold">GIS-E4030 - GIS Development L</h6>
              <p class="pull-right"> The documentation could be founded in the <a href="https://version.aalto.fi/gitlab/heikkij16/gis-dev-proj/wikis/home" target="_blank">Wiki Page</a> or in our<a href="https://drive.google.com/open?id=14zajvUcBZ82NwmdH_OfBrTHQUeHl9g24" target="_blank"> Google drive</a>.</p>
      
            </div>      
            <hr class="clearfix w-100 d-md-none pb-3">
            <div class="col-md-6 mb-md-0 mb-3 text-center">
            <h6 class="text-uppercase font-weight-bold ">People involved</h6>
              <a href="mailto:juhani.heikkila@aalto.fi"> Juhani Heikkil√§,</a>
            <a href="mailto:tekla.Larinkoski@aalto.fi"> Tekla Larinkoski,</a>
            <a href="mailto:jhosimar.aguaciafisco@aalto.fi"> Jhosimar Aguacia,</a>
            <a href="mailto:bijay.karkir@aalto.fi"> Bijay Karki.</a>     
            </div>
      
          </div>
        </div>
        </div>
      
      </footer>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>

</html>