<!DOCTYPE HTML>
{% load static %}
{% load leaflet_tags %}

<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>

    {% leaflet_js %}
    {% leaflet_css %}

    <style>
        .leaflet-container {
            height: 550px;
            width: 100%;
        }
    </style>

    <link rel="stylesheet" href="{% static 'leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.min.css' %}">
    <script type="text/javascript" src="{% static 'leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.min.js' %}">
    </script>
    <script type="text/javascript" src="{% static 'leaflet-ajax/leaflet.ajax.min.js' %}"></script>

    <script type='text/javascript'>
        var Lgrp = new L.LayerGroup();
        var flayer = L.geoJSON();

        var tik = new L.LayerGroup();
        var tuas = new L.LayerGroup();


        function tik_layers(map, options) {


        };

        var imagery = L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                id: 'MapID',
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }),
        streets = L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                id: 'MapID',
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
            });

        
        var osmLayer;
        window.addEventListener("map:init", function (event) {
            
            map = event.detail.map;

            map.eachLayer(function (layer) {
                osmLayer = layer;
            });

            map.on('contextmenu', mapclick);

            var tik_1 = new L.GeoJSON.AJAX("{% url 'TIK' 1 %}", {
                onEachFeature: function(feature, layer){
                    layer.bindPopup(feature.properties.building_name.toString());
                }
            });
            var tik_2 = new L.GeoJSON.AJAX("{% url 'TIK' 2 %}", {
                onEachFeature: function(feature, layer){
                    layer.bindPopup(feature.properties.building_name.toString());
                }
            });
            var tik_3 = new L.GeoJSON.AJAX("{% url 'TIK' 3 %}", {
                onEachFeature: function(feature, layer){
                    layer.bindPopup(feature.properties.building_name.toString());
                }
            });

            var tuas_1 = new L.GeoJSON.AJAX("{% url 'TUAS' 1 %}", {
                onEachFeature: function(feature, layer){
                    layer.bindPopup(feature.properties.building_name.toString());
                }
            });
            var tuas_2 = new L.GeoJSON.AJAX("{% url 'TUAS' 2 %}", {
                onEachFeature: function(feature, layer){
                    layer.bindPopup(feature.properties.building_name.toString());
                }
            });
            var tuas_3 = new L.GeoJSON.AJAX("{% url 'TUAS' 3 %}", {
                onEachFeature: function(feature, layer){
                    layer.bindPopup(feature.properties.building_name.toString());
                }
            });
            var tuas_4 = new L.GeoJSON.AJAX("{% url 'TUAS' 4 %}", {
                onEachFeature: function(feature, layer){
                    layer.bindPopup(feature.properties.building_name.toString());
                }
            });

            tik_1.addTo(map)
            tuas_1.addTo(map)
            
            var baseMaps = {
                "Imagery": imagery,
                "Streets": osmLayer,
            };
            var groupedOverlays = {
                "TIK": {
                    "First Floor": tik_1,
                    "Second Floor": tik_2,
                    "Third Floor": tik_3,
                },
                "TUAS": {
                    "First Floor": tuas_1,
                    "Second Floor": tuas_2,
                    "Third Floor": tuas_3,
                    "Fourth Floor": tuas_4,
                }
            };

            var options = {
                // Make the "Landmarks" group exclusive (use radio inputs)
                exclusiveGroups: ["TUAS", "TIK"],
                // Show a checkbox next to non-exclusive group labels for toggling all
                groupCheckboxes: false
            };

            L.control.groupedLayers(baseMaps, groupedOverlays, options).addTo(map);

        }, );

        function mapclick(loc) {
            if (!loc.originalEvent.shiftKey) {

                if (!window.startm) {
                    window.startm = L.marker(loc.latlng);
                    window.startm.addTo(window.map);
                } else if (!window.endm) {
                    window.endm = L.marker(loc.latlng);
                    window.endm.addTo(window.map);
                    linedistance();

                } else {
                    window.endm.remove();
                    window.endm = window.startm;
                    window.startm = L.marker(loc.latlng);
                    window.startm.addTo(window.map);
                    linedistance();

                }
            }
        }

        function linedistance() {
            {
                // #a very basic dummy solution set to work at latitude of 60.187#
            }
            if (window.pline) {
                window.pline.remove();
            }
            var diff_lat = (window.endm._latlng.lat - window.startm._latlng.lat) * 111415.41;
            var diff_lng = (window.endm._latlng.lng - window.startm._latlng.lng) * 55484.77;
            var dist = Math.sqrt((Math.pow(diff_lat, 2)) + Math.pow(diff_lng, 2));

            var coords = [
                [window.startm._latlng.lat, window.startm._latlng.lng],
                [window.endm._latlng.lat, window.endm._latlng.lng]
            ];
            window.pline = L.polyline(coords, {
                color: 'red'
            });
            window.pline.bindPopup("<h3>Distance between points: " + dist + " meters!</h3>");
            window.pline.addTo(map);
            window.pline.openPopup();
            console.log(dist + " meters");
        }
    </script>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark shadow-sm">
        <a class="navbar-brand" href="#">
            <img src="{% static 'icons/Aalto.png' %}" width="65" height="60" alt=""><strong> Map service</strong>
        </a>

    </nav>
    {% leaflet_map "mappu" callback="window.tik_layers" %}

    <footer class="text-muted">
        <div class="container">
            <p class="float-right">
                <a href="https://version.aalto.fi/gitlab/heikkij16/gis-dev-proj" target="_blank">Source Code</a>
            </p>
            <p>GIS-E4030 - GIS Development L</p>
            <p>Documentation <a href="https://version.aalto.fi/gitlab/heikkij16/gis-dev-proj/wikis/home" target="_blank">Visit the Wiki</a> or access our google drive<a href="https://drive.google.com/open?id=14zajvUcBZ82NwmdH_OfBrTHQUeHl9g24" target="_blank"> Google drive</a>.</p>
        </div>
    </footer>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>

</html>